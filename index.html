<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gesti√≥n de alertas ‚Äî Dashboard</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #ffffff; --panel: #f9f9f9; --muted: #444; --text: #222;
    --accent: rgb(25,118,210); --accent-2: #06b6d4; --success: #16a34a; --warning: #f59e0b;
    --danger: #ef4444; --card: #ffffff; --glass: #ffffff; --glass-2: #f5f5f5; --radius: 12px;
  }
  html,body{height:100%;margin:0;background:#ffffff;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:var(--text)}
  .wrap{max-width:1200px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
  .logo{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:20px;box-shadow:0 6px 20px rgba(25,118,210,0.25)}
  h1{margin:0;font-size:20px}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 4px 10px rgba(0,0,0,0.08);border:1px solid #e0e0e0;}

  /* Desplegables */
  .select {
    font-size:14px;padding:8px 12px;border-radius:10px;
    border:1px solid #ccc;background:rgb(249,249,249);
    color: var(--text);min-width:200px;
    -webkit-appearance: none;-moz-appearance: none;appearance: none;
    position: relative;
  }
  .select option { background: #fff; color: var(--text); }
  .select::-ms-expand { display: none; }
  .select-wrapper { position: relative; display:inline-block; }
  .select-wrapper::after{
    content: "‚ñæ";position: absolute;right:10px;top:50%;
    transform:translateY(-50%);color:#666;pointer-events:none;font-size:12px;
  }

  /* Botones */
  .btn{
    font-size:14px;padding:8px 12px;border-radius:10px;
    border:1px solid transparent;cursor:pointer;
    background:rgb(25,118,210);color:white;
    box-shadow:0 4px 10px rgba(25,118,210,0.25);
    transition:transform .12s ease, box-shadow .12s;
  }
  .btn:active{transform:translateY(1px)}
  .btn.warn{ background:rgb(25,118,210); color:white; }

  .small{font-size:12px;color:var(--muted)}
  .summaries{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
  .summary{flex:1;min-width:160px;padding:12px;border-radius:12px;background:#fafafa;display:flex;flex-direction:column;gap:8px;border:1px solid #eee}
  .summary .num{font-size:20px;font-weight:700}
  .summary .lbl{color:var(--muted);font-size:12px}
  .table-wrap{margin-top:18px;border-radius:12px;border:1px solid #e0e0e0;overflow-x: auto; overflow-y: hidden;}
  table{ width:max-content; min-width:100%; border-collapse:collapse; font-size:13px; background:#fff; }
  thead th{position:sticky;top:0;background:#f0f0f0;padding:10px;text-align:left;color:#444;font-weight:600}
  tbody td{padding:9px;border-top:1px solid #eee;vertical-align:middle;color:var(--text)}
  tbody tr:nth-child(even){background:#fafafa}
  .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .badge.low{background:#d9fbe5;color:var(--success)}
  .badge.medium{background:#fff3cd;color:var(--warning)}
  .badge.high{background:#fde2e2;color:var(--danger)}
  .badge.critical{background:linear-gradient(90deg,#ef4444,#ef6a6a);color:white}
  .empty-message { padding: 30px; text-align:center; color: var(--muted); font-size: 15px; }
  .empty-message strong { color: var(--text); }
  .loader{width:18px;height:18px;border-radius:50%;border:2px solid #eee;border-top-color:var(--accent);animation:spin 0.8s linear infinite;display:inline-block;vertical-align:middle}
  @keyframes spin{to{transform:rotate(360deg)}}
  .log{margin-top:14px;background:#fafafa;padding:12px;border-radius:10px;color:var(--muted);font-size:13px;max-height:160px;overflow:auto;border:1px solid #eee}

  /* Input gris√°ceo para ‚ÄúIntroduce IP o Dominio...‚Äù */
  #lookupInput {
    background: #f5f5f5;
    color: var(--text);
    border: 1px solid #ccc;
  }
  #lookupInput::placeholder {
    color: #666;
    opacity: 0.8;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">üõ°Ô∏è</div>
      <div>
        <h1>Panel de Alertas</h1>
        <p class="lead">Visualiza los √∫ltimos ataques por cliente y tipo.</p>
      </div>
    </header>

    <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center; flex-wrap: wrap;">
          <span class="select-wrapper"><select id="clientSelect" class="select"></select></span>

          <span class="select-wrapper">
            <select id="attackSelect" class="select" title="Selecciona tipo">
              <option value="">‚Äî Selecciona tipo ‚Äî</option>
            </select>
          </span>

          <span class="select-wrapper">
            <select id="statusSelect" class="select" title="Filtrar por estado">
              <option value="">‚Äî Estado (todos) ‚Äî</option>
            </select>
          </span>

          <span class="select-wrapper">
            <select id="riskSelect" class="select" title="Filtrar por riesgo">
              <option value="">‚Äî Riesgo (todos) ‚Äî</option>
              <option value="bajo">Bajo</option>
              <option value="medio">Medio</option>
              <option value="alto">Alto</option>
              <option value="critico">Cr√≠tico</option>
            </select>
          </span>

          <span class="select-wrapper">
            <select id="periodSelect" class="select" title="Selecciona el periodo/√∫ltimos N">
              <option value="">‚Äî Periodo / √öltimos ‚Äî</option>
              <option value="24h">√öltimas 24 horas</option>
              <option value="7d">√öltimos 7 d√≠as</option>
              <option value="1m">√öltimo mes</option>
              <option value="3m">√öltimos 3 meses</option>
              <option value="6m">√öltimos 6 meses</option>
              <option value="1y">√öltimo a√±o</option>
              <option value="10">10 √∫ltimos ataques</option>
              <option value="20" selected>20 √∫ltimos ataques</option>
              <option value="50">50 √∫ltimos ataques</option>
            </select>
          </span>

          <button id="btnFetch" class="btn">Buscar</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <button id="btnCSV" class="btn">Exportar CSV</button>
          <button id="btnSimulate" class="btn">Simular ataque</button>
          <span id="status" class="small" style="margin-left:8px"></span>
        </div>
      </div>

      <div style="flex:1;min-width:280px">
        <div class="summaries">
          <div class="summary card"><div class="num" id="countDisplay">‚Äî</div><div class="lbl">Filas devueltas</div></div>
          <div class="summary card"><div class="num small" id="lastUpdate">‚Äî</div><div class="lbl">√öltima actualizaci√≥n</div></div>
        </div>
        <div class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 8px 0; font-size: 14px; color: var(--accent-2);">An√°lisis R√°pido de Indicadores</h3>
          <div style="display:flex; gap:8px;">
            <input type="text" id="lookupInput" class="select" style="flex:1;" placeholder="Introduce IP o Dominio...">
            <button id="btnLookup" class="btn">Consultar</button>
          </div>
          <div id="lookupResultArea" style="margin-top:10px; font-size:13px;"></div>
        </div>
      </div>
    </div>

    <div class="table-wrap card" id="tableWrap" style="margin-top:14px;display:none"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px; display: none;" id="saveChangesContainer">
        <button id="btnSave" class="btn">Guardar Cambios</button>
        <span class="small">Usa ‚Äúcheck/dismiss‚Äù por fila; se aplican las transiciones permitidas.</span>
    </div>
    <div class="log card" id="logArea">Listo.</div>
  </div>

<script>
    const G = {
        client: document.getElementById("clientSelect"),
        attack: document.getElementById("attackSelect"),
        status: document.getElementById("statusSelect"),
        risk: document.getElementById("riskSelect"),
        period: document.getElementById("periodSelect"),
        btnFetch: document.getElementById("btnFetch"),
        btnCSV: document.getElementById("btnCSV"),
        btnSimulate: document.getElementById("btnSimulate"),
        btnSave: document.getElementById("btnSave"),
        statusMsg: document.getElementById("status"),
        tableWrap: document.getElementById("tableWrap"),
        countDisplay: document.getElementById("countDisplay"),
        lastUpdate: document.getElementById("lastUpdate"),
        logArea: document.getElementById("logArea"),
        lookupInput: document.getElementById("lookupInput"),
        btnLookup: document.getElementById("btnLookup"),
        lookupResultArea: document.getElementById("lookupResultArea"),
        saveChangesContainer: document.getElementById("saveChangesContainer"),
        STATUS_MAP: {},
        pendingChanges: new Map()
    };

    function log(msg) {
        const ts = new Date().toLocaleString('es-ES');
        G.logArea.textContent = `[${ts}] ${msg}\n` + G.logArea.textContent;
    }

    function escapeHtml(s) {
        if (s === null || s === undefined) return "";
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}['&'] || c));
    }

    async function fetchJSON(url, opts) {
        const r = await fetch(url, opts);
        const data = await r.json().catch(() => ({ ok: false, error: 'Respuesta inv√°lida del servidor' }));
        if (!r.ok) throw new Error(data.error || `Error HTTP ${r.status}`);
        return data;
    }

    // üîπ Fallbacks (coinciden con los cat√°logos del backend)
    const FALLBACK_TYPES = [
      { codigo: 'dos', descripcion: 'DoS' },
      { codigo: 'ddos', descripcion: 'DDoS' },
      { codigo: 'fuerza_bruta', descripcion: 'Fuerza bruta' },
      { codigo: 'login_sospechoso', descripcion: 'Login sospechoso' },
      { codigo: 'phishing', descripcion: 'Phishing' },
    ];
    const FALLBACK_STATUS = [
      { id_status: 1, codigo: 'new',        descripcion: 'Alerta nueva' },
      { id_status: 2, codigo: 'processing', descripcion: 'Alerta en proceso' },
      { id_status: 3, codigo: 'finished',   descripcion: 'Alerta resuelta' },
    ];

    function prettyNameForAttackCode(code) {
      if (!code) return '';
      const map = {
        'dos': 'DoS',
        'ddos': 'DDoS',
        'fuerza_bruta': 'Fuerza bruta',
        'login_sospechoso': 'Login sospechoso',
        'phishing': 'Phishing'
      };
      return map[code] || code;
    }

    async function loadInitialData() {
        G.statusMsg.innerHTML = '<span class="loader"></span> cargando...';
        try {
            // CLIENTES
            try {
              const cResp = await fetchJSON("/api/clients");
              if (cResp.ok && Array.isArray(cResp.clients)) {
                G.client.innerHTML = `<option value="">‚Äî Cliente (todos) ‚Äî</option>` +
                  cResp.clients.map(c => `<option value="${c.id_cliente}">${escapeHtml(c.nombre)}</option>`).join("");
              } else {
                G.client.innerHTML = `<option value="">‚Äî Cliente (todos) ‚Äî</option>`;
              }
            } catch(e) {
              // Pool ca√≠do: mantenemos placeholder
              G.client.innerHTML = `<option value="">‚Äî Cliente (todos) ‚Äî</option>`;
              log("Aviso: no se pudo cargar /api/clients (usando placeholder).");
            }

            // TIPOS DE ATAQUE (mostrar c√≥digos)
            try {
              const tResp = await fetchJSON("/api/attack-types");
              if (tResp.ok && Array.isArray(tResp.types) && tResp.types.length) {
                G.attack.innerHTML = `<option value="">‚Äî Selecciona tipo ‚Äî</option>` +
                  tResp.types.map(t => `<option value="${t.codigo}">${escapeHtml(t.codigo)}</option>`).join("");
              } else {
                throw new Error("Respuesta vac√≠a");
              }
            } catch(e) {
              // Fallback local
              G.attack.innerHTML = `<option value="">‚Äî Selecciona tipo ‚Äî</option>` +
                FALLBACK_TYPES.map(t => `<option value="${t.codigo}">${t.codigo}</option>`).join("");
              log("Aviso: no se pudo cargar /api/attack-types (fallback local).");
            }

            // ESTADOS
            try {
              const sResp = await fetchJSON("/api/alert-status");
              if (sResp.ok && Array.isArray(sResp.status) && sResp.status.length) {
                G.status.innerHTML = `<option value="">‚Äî Estado (todos) ‚Äî</option>` +
                  sResp.status.map(s => {
                    G.STATUS_MAP[s.id_status] = s.codigo;
                    return `<option value="${s.codigo}">${escapeHtml(s.descripcion)}</option>`;
                  }).join("");
              } else {
                throw new Error("Respuesta vac√≠a");
              }
            } catch(e) {
              G.status.innerHTML = `<option value="">‚Äî Estado (todos) ‚Äî</option>` +
                FALLBACK_STATUS.map(s => {
                  G.STATUS_MAP[s.id_status] = s.codigo;
                  return `<option value="${s.codigo}">${s.descripcion}</option>`;
                }).join("");
              log("Aviso: no se pudo cargar /api/alert-status (fallback local).");
            }

            G.statusMsg.textContent = "Listo.";
        } catch (err) {
            G.statusMsg.textContent = "Error de carga";
            log("Error en carga inicial: " + err.message);
        }
    }

    function renderBadge(riesgo) {
        const r = String(riesgo || "").toLowerCase();
        if (r.includes("cr√≠t")) return `<span class="badge critical">CR√çTICO</span>`;
        if (r.includes("alto")) return `<span class="badge high">ALTO</span>`;
        if (r.includes("med")) return `<span class="badge medium">MEDIO</span>`;
        if (r.includes("bajo")) return `<span class="badge low">BAJO</span>`;
        return "";
    }

    window._onActionChange = (id, action) => G.pendingChanges.set(id, action);

    function renderActionCell(row) {
        const code = row.id_status_txt || 'new';
        const allow = { check: code === 'new', dismiss: code === 'new' || code === 'processing' };
        return `<div style="display:flex;gap:6px;align-items:center">
            <label style="cursor:pointer;opacity:${allow.check?1:0.4}">
                <input type="radio" name="action_${row.id}" value="check" ${allow.check?'':'disabled'}
                    onchange="window._onActionChange(${row.id},'check')"> check
            </label>
            <label style="cursor:pointer;opacity:${allow.dismiss?1:0.4}">
                <input type="radio" name="action_${row.id}" value="dismiss" ${allow.dismiss?'':'disabled'}
                    onchange="window._onActionChange(${row.id},'dismiss')"> dismiss
            </label>
        </div>`;
    }

    function renderTable(alerts, columns) {
        G.pendingChanges.clear();
        if (!alerts || alerts.length === 0) {
            G.tableWrap.innerHTML = `<div class="empty-message card">No se han encontrado alertas.</div>`;
            G.tableWrap.style.display = "block";
            G.saveChangesContainer.style.display = "none";
            G.countDisplay.textContent = "0";
            return;
        }

        G.tableWrap.innerHTML = `<table>
          <thead><tr>${columns.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}<th>Informe</th><th>Acci√≥n</th></tr></thead>
          <tbody>${
            alerts.map(row => `<tr>${
              columns.map(col => {
                let val = row[col];
                if (String(col).toLowerCase().includes('riesgo')) return `<td>${renderBadge(val)}</td>`;
                if (typeof val === 'string' && val.length > 80) val = val.substring(0, 80) + '...';
                return `<td>${escapeHtml(val)}</td>`;
              }).join('')
            }<td><button class="btn" data-id="${row.id}" data-attack="${G.attack.value}">PDF</button></td>
              <td>${renderActionCell(row)}</td></tr>`).join('')
          }</tbody></table>`;

        G.tableWrap.style.display = "block";
        G.saveChangesContainer.style.display = "flex";
        G.countDisplay.textContent = alerts.length;
        G.lastUpdate.textContent = new Date().toLocaleString('es-ES');
    }

    async function getAlerts() {
        if (!G.attack.value) return alert("Por favor, selecciona un tipo de ataque.");
        G.statusMsg.innerHTML = '<span class="loader"></span> consultando...';
        G.btnFetch.disabled = true;
        try {
            const params = new URLSearchParams({ attack: G.attack.value });
            if (G.client.value) params.set("client_id", G.client.value);
            if (G.period.value) params.set("limit", G.period.value); // 24h,7d,1m,3m,6m,1y o 10/20/50
            if (G.status.value) params.set("status", G.status.value);
            if (G.risk.value) params.set("riesgo", G.risk.value);

            const data = await fetchJSON(`/api/alerts?${params.toString()}`);
            if (data.ok) renderTable(data.alerts, data.columns);
            else throw new Error(data.error);
        } catch (err) {
            log("Error en getAlerts: " + err.message);
        } finally {
            G.statusMsg.textContent = "";
            G.btnFetch.disabled = false;
        }
    }
    
    G.btnFetch.addEventListener("click", getAlerts);
    
    G.btnSimulate.addEventListener("click", async () => {
        if (!G.client.value) return alert("Por favor, selecciona un cliente para simular.");
        if (!G.attack.value) return alert("Por favor, selecciona un tipo de ataque a simular.");
        G.statusMsg.innerHTML = '<span class="loader"></span> simulando...';
        G.btnSimulate.disabled = true;
        console.log("Simulando ataque", G.client.value, G.attack.value);
        try {
            const payload = { client_id: parseInt(G.client.value, 10), attack: G.attack.value };
            const data = await fetchJSON("/api/simulate_attack", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (data.ok) {
                log("Simulaci√≥n OK: " + JSON.stringify(data.inserted));
                renderTable([data.inserted], data.columns);
                alert("Ataque simulado y a√±adido a la tabla.");
            } else throw new Error(data.error);
        } catch (err) {
            log("Error en simulaci√≥n: " + err.message);
        } finally {
            G.statusMsg.textContent = "";
            G.btnSimulate.disabled = false;
        }
    });

    G.btnSave.addEventListener("click", async () => {
        if (!G.attack.value) return;
        const changes = Array.from(G.pendingChanges, ([id, action]) => ({ id, action }));
        if (changes.length === 0) return alert("No hay cambios para guardar.");
        G.statusMsg.innerHTML = '<span class="loader"></span> guardando...';
        G.btnSave.disabled = true;
        try {
            const data = await fetchJSON("/api/alerts/update-status", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ attack: G.attack.value, changes })
            });
            if(data.ok) {
                log(`Guardado: ${data.updated} actualizados.`);
                getAlerts();
            } else throw new Error(data.error);
        } catch (err) {
            log("Error al guardar: " + err.message);
        } finally {
            G.statusMsg.textContent = "";
            G.btnSave.disabled = false;
        }
    });
    
    G.tableWrap.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button[data-id]');
        if (!btn) return;
        btn.disabled = true;
        btn.textContent = '...';
        try {
            const url = `/api/report_by_id?attack=${encodeURIComponent(btn.dataset.attack)}&alert_id=${encodeURIComponent(btn.dataset.id)}`;
            const resp = await fetch(url);
            if (!resp.ok) {
                const errorData = await resp.json().catch(() => ({error: `Error HTTP ${resp.status}`}));
                throw new Error(errorData.error);
            }
            const blob = await resp.blob();
            const fileName = resp.headers.get('X-Report-Filename') || `informe.pdf`;
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            window.URL.revokeObjectURL(link.href);
            link.remove();
        } catch (err) {
            log('Error descargando informe: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'PDF';
        }
    });

    G.btnLookup.addEventListener("click", async () => {
        if (!G.lookupInput.value.trim()) return;
        G.lookupResultArea.innerHTML = '<span class="loader"></span> Analizando...';
        G.btnLookup.disabled = true;
        try {
            const data = await fetchJSON("/api/lookup", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ indicator: G.lookupInput.value.trim() })
            });
            if (data.ok) {
                const r = data.results, summary = r.summary || {};
                G.lookupResultArea.innerHTML = `<p style="margin:0;"><strong>${escapeHtml(r.indicator)} (${escapeHtml(r.type)})</strong></p>
                    <p style="margin:4px 0;"><strong>Riesgo:</strong> ${renderBadge(summary.risk_level)}</p>
                    <ul style="margin:4px 0;padding-left:20px;color:var(--muted);">
                        <li>Score: <strong>${summary.risk_score||0}</strong></li>
                        <li>Pa√≠s: <strong>${escapeHtml(r.country)||'N/A'}</strong></li>
                        <li>ISP: <strong>${escapeHtml(r.isp)||'N/A'}</strong></li>
                    </ul>`;
            } else throw new Error(data.error);
        } catch (err) {
            G.lookupResultArea.innerHTML = `<p style="color:var(--danger);">Error: ${escapeHtml(err.message)}</p>`;
        } finally {
            G.btnLookup.disabled = false;
        }
    });

    loadInitialData();
</script>
</body>
</html>
